@using SlimTrack.Shared
@code {
    [Parameter] public List<WeightEntryDto> Items { get; set; } = [];
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<WeightEntryDto> OnEdit { get; set; }

    private int currentPage = 1;
    private int pageSize = 20;

    private int TotalPages => (int)Math.Ceiling((double)Items.Count / pageSize);
    private List<WeightEntryDto> PagedItems => Items
    .OrderByDescending(x => x.Date)
    .Skip((currentPage - 1) * pageSize)
    .Take(pageSize)
    .ToList();

    private void NextPage()
    {
        if (currentPage < TotalPages)
            currentPage++;
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
            currentPage--;
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
            currentPage = page;
    }

    protected override void OnParametersSet()
    {
        // 当数据变化时，确保当前页不超过总页数
        if (currentPage > TotalPages && TotalPages > 0)
            currentPage = TotalPages;
        if (currentPage < 1)
            currentPage = 1;
    }
}
<table class="table">
    <thead>
        <tr>
            <th>日期</th>
            <th>体重(斤)</th>
            <th>体重(公斤)</th>
            <th>腰围(厘米)</th>
            <th>备注</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var x in PagedItems)
        {
            <tr class="table-row-clickable" @onclick="() => OnEdit.InvokeAsync(x)">
                <td>@x.Date.ToString("yyyy-MM-dd")</td>
                <td>@x.WeightJin.ToString("F2")</td>
                <td>@x.WeightGongJin.ToString("F2")</td>
                <td>@(x.WaistCircumference?.ToString("F2") ?? "-")</td>
                <td>@x.Note</td>
                <td @onclick:stopPropagation="true">
                    <button @onclick="() => OnDelete.InvokeAsync(x.Id)">删除</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@if (TotalPages > 1)
{
    <div class="pagination">
        <button class="page-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">上一页</button>

        <div class="page-numbers">
            @if (currentPage > 2)
            {
                <button class="page-number" @onclick="() => GoToPage(1)">1</button>
                @if (currentPage > 3)
                {
                    <span class="page-ellipsis">...</span>
                }
            }

            @for (int i = Math.Max(1, currentPage - 1); i <= Math.Min(TotalPages, currentPage + 1); i++)
            {
                var pageNum = i;
                <button class="page-number @(pageNum == currentPage ? "active" : "")"
                    @onclick="() => GoToPage(pageNum)">@pageNum</button>
            }

            @if (currentPage < TotalPages - 1)
            {
                @if (currentPage < TotalPages - 2)
                {
                    <span class="page-ellipsis">...</span>
                }
                <button class="page-number" @onclick="() => GoToPage(TotalPages)">@TotalPages</button>
            }
        </div>

        <button class="page-btn" @onclick="NextPage" disabled="@(currentPage == TotalPages)">下一页</button>
    </div>

    <div class="pagination-info">
        第 @currentPage 页 / 共 @TotalPages 页 (总计 @Items.Count 条)
    </div>
}